name: Build Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 0.22.0)'
        required: true
        default: '0.22.0'

permissions:
  contents: write

jobs:
  build-installer:
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'
          cache: 'npm'

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
          cache-dependency-path: src/app/go.sum

      - name: Install NSIS
        run: |
          choco install nsis -y
          refreshenv

      - name: Install dependencies
        run: npm ci

      - name: Build Client (Next.js)
        run: npm run build:client

      - name: Build Go Application
        run: npm run build:app

      - name: Build Service
        run: npm run build:service

      - name: Build Installer
        run: npm run build:package
        continue-on-error: false

      - name: Get version
        id: version
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $VERSION = "${{ github.event.inputs.version }}"
          } else {
            $VERSION = "${{ github.ref_name }}".TrimStart('v')
          }
          echo "VERSION=$VERSION" >> $env:GITHUB_OUTPUT
          echo "Building version: $VERSION"
        shell: pwsh

      - name: Find installer
        id: find_installer
        run: |
          $INSTALLER = Get-ChildItem -Path "dist" -Filter "*.exe" | Select-Object -First 1
          if ($INSTALLER) {
            echo "INSTALLER_PATH=$($INSTALLER.FullName)" >> $env:GITHUB_OUTPUT
            echo "INSTALLER_NAME=$($INSTALLER.Name)" >> $env:GITHUB_OUTPUT
            echo "Found installer: $($INSTALLER.Name)"
          } else {
            echo "Error: No installer found in dist/"
            exit 1
          }
        shell: pwsh

      - name: Upload Installer as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: icarus-terminal-installer
          path: ${{ steps.find_installer.outputs.INSTALLER_PATH }}
          retention-days: 30

      - name: Create Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.find_installer.outputs.INSTALLER_PATH }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## ICARUS Terminal v${{ steps.version.outputs.VERSION }}

            ### üì¶ Installation
            Download and run `${{ steps.find_installer.outputs.INSTALLER_NAME }}`

            ### ‚ú® What's New
            - Updated to Next.js 15 with Turbopack
            - Updated to React 19 with new Compiler
            - Updated to Node.js 24 LTS
            - Updated to Go 1.24
            - Performance improvements and bug fixes

            ### üìã Requirements
            - Windows 10 or newer
            - No dependencies required (self-contained installer)

            ### üöÄ Features
            - Real-time Elite Dangerous companion interface
            - System map and navigation tools
            - Ship status and engineering information
            - Multi-screen and remote access support
            - VR overlay compatible

            ---
            For detailed changelog, see the full release notes below.
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment on manual workflow
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "‚úÖ Build completed successfully!"
          echo "üì¶ Installer: ${{ steps.find_installer.outputs.INSTALLER_NAME }}"
          echo "üìÅ Download from the Artifacts section above"
